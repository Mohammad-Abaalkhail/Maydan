name: Staging Deployment

on:
  push:
    branches: [ main ]
    tags:
      - 'v*.*.*-*'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Generate Staging Auth
        run: |
          STAGING_USER=$(openssl rand -hex 8)
          STAGING_PASS=$(openssl rand -hex 16)
          echo "STAGING_USER=$STAGING_USER" >> $GITHUB_ENV
          echo "STAGING_PASS=$STAGING_PASS" >> $GITHUB_ENV
          mkdir -p nginx/auth
          echo "$STAGING_USER:$(openssl passwd -apr1 $STAGING_PASS)" > nginx/auth/.htpasswd
      
      - name: Deploy to Staging
        env:
          STAGING_HOST: ${{ secrets.STAGING_HOST }}
          STAGING_SSH_KEY: ${{ secrets.STAGING_SSH_KEY }}
          STAGING_USER: ${{ env.STAGING_USER }}
          STAGING_PASS: ${{ env.STAGING_PASS }}
        run: |
          echo "Deploying to staging..."
          # Add SSH deployment steps here
          echo "âœ… Deployment complete"
      
      - name: Output Credentials
        run: |
          echo "::notice::Staging URL: ${{ secrets.STAGING_URL }}"
          echo "::notice::Username: ${{ env.STAGING_USER }}"
          echo "::notice::Password: ${{ env.STAGING_PASS }}"

  e2e-tests:
    name: E2E Tests on Staging
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install Playwright
        run: |
          cd tests/e2e
          npm ci
          npx playwright install --with-deps
      
      - name: Run E2E Tests
        env:
          PLAYWRIGHT_BASE_URL: ${{ secrets.STAGING_URL }}
          STAGING_AUTH_USER: ${{ needs.deploy.outputs.staging_user }}
          STAGING_AUTH_PASS: ${{ needs.deploy.outputs.staging_pass }}
        run: |
          cd tests/e2e
          npx playwright test --reporter=html
      
      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report-staging
          path: tests/e2e/playwright-report
          retention-days: 30

  load-test:
    name: Load Test
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install Dependencies
        run: |
          cd backend
          npm ci
      
      - name: Run Load Test
        env:
          SERVER_URL: ${{ secrets.STAGING_URL }}
        run: |
          cd tests/load
          node load-test.js
      
      - name: Upload Load Test Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: load-test-results
          path: tests/load/*.json
          retention-days: 30

